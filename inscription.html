<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S'inscrire — KYOCERA</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/png" href="Image/logo.png" />
    <style>
        /* Remove border of main container only on index page */
        .content-area { border: none !important; }
        /* Remove shadow/border from the top hero image */
        .newsletter-hero img { box-shadow: none !important; border: none !important; }
        /* Tile layout to match reference */
        .cards-grid.kyo-tiles { gap: 36px; }
        .kyo-tile { background: transparent; border: none; box-shadow: none; border-radius: 0; }
        .kyo-tile-media { display: block; position: relative; }
        .kyo-tile-media img { display: block; width: 100%; height: 360px; object-fit: cover; border-radius: 0; box-shadow: none; }
        .kyo-tile-plus {
          position: absolute; right: 0; bottom: 0;
          width: 72px; height: 72px;
          background: #12a7cf; color: #fff;
          display: flex; align-items: center; justify-content: center;
          font-size: 48px; font-weight: 400; line-height: 1;
        }
        .kyo-tile-body { padding-top: 18px; }
        .kyo-tile-body h3 { margin: 0 0 10px; font-size: 1.25rem; line-height: 1.35; }
        .kyo-tile-body p { margin: 0; color: #333; }

        /* Register form */
        .register-card { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:24px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
        .form-row { display:flex; gap:16px; }
        .form-row .form-group { flex:1; }
        .form-group { display:flex; flex-direction:column; margin-bottom:14px; }
        .form-group label { font-weight:600; margin-bottom:6px; }
        .kyo-input { padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
        .kyo-input:focus { outline:none; border-color:#0a9bcd; box-shadow:0 0 0 3px rgba(10,155,205,0.15); }
        .kyo-button { display:inline-block; padding:12px 18px; background:#0a9bcd; color:#fff; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
        .kyo-button:hover { background:#098db9; }
        .checkbox { display:flex; gap:8px; align-items:flex-start; }
        .form-message { margin-top:10px; font-weight:600; }

        @media (max-width: 768px) {
          .kyo-tile-media img { height: 220px; }
          .kyo-tile-plus { width: 56px; height: 56px; font-size: 36px; }
          .form-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Header (same design as index.html) -->
    <header class="kyocera-header">
        <!-- Desktop Header -->
        <div class="header-top desktop-header">
            <div class="header-logo">
                <a href="https://www.kyoceradocumentsolutions.fr/fr.html">
                    <img src="Image/logo.png" />
                </a>
                <span class="header-logo-text">KYOCERA Document Solutions</span>
            </div>
            <div class="header-lang-account">
                <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us/kyocera-worldwide.html" class="lang-text">
                    <img src="Image/fr.svg" alt="France" class="flag-icon" />
                    FR France
                </a>
                <a href="https://mykyocera.kyoceradocumentsolutions.fr/fr.html" class="account-text">My Kyocera</a>
            </div>
        </div>

        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="mobile-header-top">
                <div class="header-logo">
                    <a href="https://www.kyoceradocumentsolutions.fr/fr.html">
                        <img src="Image/logo.png" />
                    </a>
                    <span class="header-logo-text">KYOCERA Document Solutions</span>
                </div>
            </div>
            <div class="mobile-header-bottom">
                <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us/kyocera-worldwide.html" class="mobile-lang-text">
                    <i class="fas fa-globe"></i>
                    FR / France
                </a>
                <div class="mobile-icons-group">
                    <a href="https://mykyocera.kyoceradocumentsolutions.fr/fr.html">
                        <img src="Image/mykyocer.svg" alt="My Kyocera" class="mobile-user-icon" />
                    </a>
                    <button class="hamburger mobile-hamburger" id="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </div>

        <nav class="header-nav" id="headerNav">
            <ul class="nav-menu">
                <li><a href="https://www.kyoceradocumentsolutions.fr/fr/smarter-workspaces.html">Espaces de travail intelligents</a></li>
                <li><a href="https://www.kyoceradocumentsolutions.fr/fr/content-services.html">Business Solutions</a></li>
                <li><a href="https://www.kyoceradocumentsolutions.fr/fr/products.html">Produits</a></li>
                <li><a href="https://www.kyoceradocumentsolutions.fr/fr/support.html">Support</a></li>
                <li><a href="https://www.kyoceradocumentsolutions.fr/fr/about-us.html">Qui sommes-nous</a></li>
            </ul>
        </nav>

    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <div class="content-area">
                <div class="register-card">
                    <h1 class="font-size-26" style="margin-bottom:12px;">S'inscrire</h1>
                    <p style="margin-bottom:18px; color:#555;">Créez votre compte pour accéder aux contenus et téléchargements.</p>
                    <form id="registerForm" novalidate>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">Prénom</label>
                                <input id="firstName" name="firstName" type="text" class="kyo-input" required />
                            </div>
                            <div class="form-group">
                                <label for="lastName">Nom</label>
                                <input id="lastName" name="lastName" type="text" class="kyo-input" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company">Société</label>
                                <input id="company" name="company" type="text" class="kyo-input" />
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input id="email" name="email" type="email" class="kyo-input" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">Mot de passe</label>
                                <input id="password" name="password" type="password" class="kyo-input" minlength="8" required />
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirmer le mot de passe</label>
                                <input id="confirmPassword" name="confirmPassword" type="password" class="kyo-input" minlength="8" required />
                            </div>
                        </div>
                        <div class="form-group checkbox">
                            <input id="consent" type="checkbox" required />
                            <label for="consent">J’accepte la <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/privacy-and-cookie-centre.html" target="_blank" rel="noopener">politique de confidentialité</a></label>
                        </div>
                        <div class="form-group checkbox">
                            <input id="newsletterOptin" type="checkbox" />
                            <label for="newsletterOptin">Je souhaite recevoir des communications</label>
                        </div>
                        <button type="submit" class="kyo-button">Créer mon compte</button>
                        <div id="formMessage" class="form-message" aria-live="polite"></div>
                        <div id="calendarActions" class="calendar-actions" style="margin-top:12px; display:none;">
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button type="button" id="btnIcs" class="kyo-button">Télécharger .ics (Outlook/Apple)</button>
                                <button type="button" id="btnGoogle" class="kyo-button">Ajouter à Google Calendar</button>
                                <button type="button" id="btnOutlook" class="kyo-button">Ajouter à Outlook Web</button>
                            </div>
                            <div id="calendarHelp" style="margin-top:8px; color:#555; font-size:13px;"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer (same design as index.html) -->
    <footer class="kyocera-footer">
        <div class="footer-content">
            <div class="footer-main desktop-footer">
                <div class="footer-row footer-row-1">
                    <div class="footer-social-icons">
                        <a href="https://www.facebook.com/KyoceraDocumentSolutionsFrance/"><img src="Image/facebook.png" alt="Facebook" /></a>
                        <a href="https://www.linkedin.com/company/kyocera-document-solutions-france/posts/?feedView=all"><img src="Image/linkin.png" alt="LinkedIn" /></a>
                        <a href="https://www.youtube.com/user/kdfrsas"><img src="Image/video.png" alt="YouTube" /></a>
                    </div>
                </div>
                <div class="footer-row footer-row-2">
                    <div class="footer-left">
                        <div class="footer-links">
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us.html">Nous contacter</a>
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/privacy-and-cookie-centre.html">Utilisation des cookies</a>
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/data-request.html">Politique de gestion des données personnelles</a>
                        </div>
                    </div>
                    <div class="footer-right">
                        <div class="footer-copyright">©2025 KYOCERA Document Solutions France S.A.S.</div>
                    </div>
                </div>
                <div class="footer-row footer-row-3">
                    <div class="footer-left">
                        <div class="footer-links">
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/terms-of-use.html">Conditions d'utilisation et restrictions légales</a>
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/legal-notices.html">Conditions Générales de Vente</a>
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/gdpr-preferences.html">Gérer vos cookies</a>
                            <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us/press.html">Presse</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-main mobile-footer">
                <div class="mobile-footer-social">
                    <a href="https://www.facebook.com/kyoceradocumentsolutions"><img src="Image/facebook.png" alt="Facebook" /></a>
                    <a href="https://www.linkedin.com/company/kyocera-document-solutions"><img src="Image/linkin.png" alt="LinkedIn" /></a>
                    <a href="https://www.youtube.com/user/kyoceradocumentsolutions"><img src="Image/video.png" alt="YouTube" /></a>
                </div>
                <div class="mobile-footer-links">
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us.html">Nous contacter</a>
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/privacy-and-cookie-centre.html">Utilisation des cookies</a>
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/data-request.html">Politique de gestion des données personnelles</a>
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/terms-of-use.html">Conditions d'utilisation et restrictions légales</a>
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/footer/legal-notices.html">Conditions Générales de Vente</a>
                    <a href="https://www.kyoceradocdocumentsolutions.fr/fr/gdpr-preferences.html">Gérer vos cookies</a>
                    <a href="https://www.kyoceradocumentsolutions.fr/fr/about-us/contact-us/press.html">Presse</a>
                </div>
                <div class="mobile-footer-copyright">©2025 KYOCERA Document Solutions France S.A.S.</div>
            </div>
        </div>
    </footer>



    <!-- Minimal JS to keep menu/search behavior consistent with index.html -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const hamburger = document.getElementById('hamburger');
            const headerNav = document.querySelector('.header-nav');
            if (hamburger && headerNav) {
                hamburger.addEventListener('click', function () {
                    headerNav.classList.toggle('active');
                    const spans = hamburger.querySelectorAll('span');
                    if (headerNav.classList.contains('active')) {
                        spans[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
                        spans[1].style.opacity = '0';
                        spans[2].style.transform = 'rotate(-45deg) translate(7px, -6px)';
                    } else {
                        spans[0].style.transform = 'none';
                        spans[1].style.opacity = '1';
                        spans[2].style.transform = 'none';
                    }
                });
            }
        });
    </script>
    <!-- Loader for content1-4 into main content area -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectEl = document.getElementById('contentSelect');
            const statusEl = document.getElementById('contentStatus');
            const targetEl = document.getElementById('loadedContent');
            
            // Helper to read URL query parameters
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }

            // Extract a title, prioritizing an element styled with font-size: 52px
            function extractTitleFromDoc(doc) {
                // 1) Look for explicit inline style font-size:52px
                let el = doc.querySelector('span[style*="font-size: 52px"], span[style*="font-size:52px"], [style*="font-size: 52px"], [style*="font-size:52px"]');
                if (el && (el.innerText || el.textContent)) return (el.innerText || el.textContent).trim();

                // 2) Look for font tag with size="7" as seen in content1.html
                el = doc.querySelector('font[size="7"]');
                if (el && (el.innerText || el.textContent)) return (el.innerText || el.textContent).trim();

                // 3) Fallback to headline tags
                el = doc.querySelector('h1, h2, h3');
                if (el && (el.innerText || el.textContent)) return (el.innerText || el.textContent).trim();

                return '';
            }

            // Sync dropdown option labels with extracted titles from content files
            async function syncDropdownLabels() {
                if (!selectEl) return;
                const opts = Array.from(selectEl.options).filter(o => o.value && o.value.endsWith('.html'));
                for (const opt of opts) {
                    try {
                        // Use new file names for sync
                        let syncFile = opt.value;
                        if (syncFile === 'contenuDeGauche.html' || syncFile === 'teteSuperieure.html' || syncFile === 'contenuCentral.html' || syncFile === 'contenuDeDroite.html') {
                            const res = await fetch(`${syncFile}?t=${Date.now()}`);
                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            const html = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const title = extractTitleFromDoc(doc);
                            if (title) opt.textContent = title;
                        }
                    } catch (e) {
                        console.warn('Label sync failed for', opt.value, e);
                    }
                }
            }

            // Kick off label sync on load, then load content based on URL parameter
            syncDropdownLabels().then(() => {
                if (selectEl) {
                    const page = getUrlParameter('page');
                    let contentFile = '';
                    // Map page numbers to new content files if page parameter exists
                    if (page) {
                        switch(page) {
                            case '1':
                                contentFile = 'teteSuperieure.html'; // Tête supérieure
                                break;
                            case '2':
                                contentFile = 'contenuDeGauche.html'; // Contenu de gauche
                                break;
                            case '3':
                                contentFile = 'contenuCentral.html'; // Contenu central
                                break;
                            case '4':
                                contentFile = 'contenuDeDroite.html'; // Contenu de droite
                                break;
                            default:
                                contentFile = '';
                        }
                        if (contentFile) {
                            selectEl.value = contentFile;
                            loadSelected(contentFile);
                        }
                    }
                }
            });

            async function loadSelected(path) {
                if (!path) { targetEl.innerHTML = ''; statusEl.textContent = ''; return; }
                statusEl.textContent = 'Chargement...';
                try {
                    const res = await fetch(`${path}?t=${Date.now()}`); // cache-buster
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Prefer .newsletter-content if present; otherwise fall back to <body>
                    const content = doc.querySelector('.newsletter-content') || doc.body;

                    // Build a fragment to sanitize to read-only before injecting
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = content ? content.innerHTML : html;

                    // Remove any contenteditable capability
                    wrapper.querySelectorAll('[contenteditable]').forEach(el => {
                        el.removeAttribute('contenteditable');
                        el.contentEditable = 'false';
                    });

                    // Disable form controls so they cannot be changed
                    ['input','textarea','select','button'].forEach(sel => {
                        wrapper.querySelectorAll(sel).forEach(ctrl => {
                            ctrl.setAttribute('disabled', '');
                            ctrl.setAttribute('tabindex', '-1');
                        });
                    });

                    // Inject sanitized content
                    targetEl.innerHTML = '';
                    while (wrapper.firstChild) {
                        targetEl.appendChild(wrapper.firstChild);
                    }

                    statusEl.textContent = '';
                } catch (e) {
                    console.error('Load failed:', e);
                    statusEl.textContent = 'Erreur de chargement';
                }
            }

            if (selectEl) {
                selectEl.addEventListener('change', (e) => loadSelected(e.target.value));
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Configuration for content files and their target elements
            const contentConfig = [
                {
                    source: 'teteSuperieure.html',
                    titleSelector: 'h1, h2, h3',
                    imageSelector: 'img',
                    targetTitle: '.title-accent',
                    targetImage: '.newsletter-hero img',
                    errorMsg: 'teteSuperieure (Main Title)'
                },
                {
                    source: 'contenuDeGauche.html',
                    titleSelector: 'h2, h3',
                    imageSelector: 'img',
                    targetTitle: '.cards-grid.kyo-tiles .kyo-tile:nth-child(1) h3',
                    targetImage: '.cards-grid.kyo-tiles .kyo-tile:nth-child(1) img',
                    errorMsg: 'contenuDeGauche (First Tile)'
                },
                {
                    source: 'contenuCentral.html',
                    titleSelector: 'h2, h3',
                    imageSelector: 'img',
                    targetTitle: '.cards-grid.kyo-tiles .kyo-tile:nth-child(2) h3',
                    targetImage: '.cards-grid.kyo-tiles .kyo-tile:nth-child(2) img',
                    errorMsg: 'contenuCentral (Second Tile)'
                },
                {
                    source: 'contenuDeDroite.html',
                    titleSelector: 'h2, h3',
                    imageSelector: 'img',
                    targetTitle: '.cards-grid.kyo-tiles .kyo-tile:nth-child(3) h3',
                    targetImage: '.cards-grid.kyo-tiles .kyo-tile:nth-child(3) img',
                    errorMsg: 'contenuDeDroite (Third Tile)'
                }
            ];

            // Function to fetch and update content
            async function updateContent(config) {
                try {
                    const response = await fetch(`${config.source}?t=${Date.now()}`); // Cache buster
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update title if selector exists
                    const titleElement = doc.querySelector(config.titleSelector);
                    const targetTitle = document.querySelector(config.targetTitle);
                    
                    if (titleElement && targetTitle) {
                        const titleText = titleElement.innerText || titleElement.textContent || '';
                        const trimmedText = titleText.trim();
                        if (trimmedText) {
                            targetTitle.textContent = trimmedText;
                        }
                    }
                    
                    // Update image if selector exists
                    const imageElement = doc.querySelector(config.imageSelector);
                    const targetImage = document.querySelector(config.targetImage);
                    
                    if (imageElement && targetImage) {
                        const imageSrc = imageElement.src || imageElement.getAttribute('src');
                        if (imageSrc) {
                            targetImage.src = imageSrc;
                            targetImage.alt = imageElement.alt || '';
                        }
                    }
                    
                    return true;
                } catch (error) {
                    return false;
                }
            }

            async function syncContentWithRetry(config, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    const success = await updateContent(config);
                    if (success) return true;
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                return false;
            }

            function initRealTimeSync() {
                contentConfig.forEach(config => {
                    syncContentWithRetry(config);
                });
                const syncInterval = setInterval(() => {
                    contentConfig.forEach(config => {
                        syncContentWithRetry(config);
                    });
                }, 5000);
                window.addEventListener('beforeunload', () => {
                    clearInterval(syncInterval);
                });
            }

            initRealTimeSync();

            // Basic front-end validation + success message (no persistence by default)
            const form = document.getElementById('registerForm');
            const msg = document.getElementById('formMessage');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    msg.textContent = '';
                    msg.style.color = '#d32f2f';

                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const company = document.getElementById('company').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const consent = document.getElementById('consent').checked;
                    const optin = document.getElementById('newsletterOptin').checked;

                    // Simple validations
                    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                    if (!firstName || !lastName || !email || !password || !confirmPassword) {
                        msg.textContent = 'Merci de compléter tous les champs obligatoires.';
                        return;
                    }
                    if (!emailOk) {
                        msg.textContent = "L'email n'est pas valide.";
                        return;
                    }
                    if (password.length < 8) {
                        msg.textContent = 'Le mot de passe doit contenir au moins 8 caractères.';
                        return;
                    }
                    if (password !== confirmPassword) {
                        msg.textContent = 'Les mots de passe ne correspondent pas.';
                        return;
                    }
                    if (!consent) {
                        msg.textContent = 'Vous devez accepter la politique de confidentialité.';
                        return;
                    }

                    // Submit to the PHP API
                    fetch('api/register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ firstName, lastName, company, email, password, optin })
                    }).then(r => r.ok ? r.json() : r.json().then(e => Promise.reject(e)))
                      .then((res) => {
                          msg.style.color = '#2e7d32';
                          msg.textContent = 'Compte créé avec succès.';
                          // Persist registration id locally for later tracking (email open / downloads)
                          try { localStorage.setItem('registrationId', res.id); } catch (_) {}
                          // Show calendar actions
                          try { document.getElementById('calendarActions').style.display = 'block'; } catch(_) {}
                          // Optionally reset form
                          form.reset();
                      })
                      .catch((e) => {
                          msg.style.color = '#d32f2f';
                          msg.textContent = (e && e.error) ? e.error : 'Une erreur est survenue lors de l’inscription.';
                      });
                });
            }
        });

        // Calendar helpers
        (function setupCalendarButtons(){
            const btnIcs = document.getElementById('btnIcs');
            const btnGoogle = document.getElementById('btnGoogle');
            const btnOutlook = document.getElementById('btnOutlook');
            const help = document.getElementById('calendarHelp');

            if (!btnIcs || !btnGoogle || !btnOutlook) return;

            // Event details (from your inputs)
            const event = {
                title: 'Social media manager : comment garder le contrôle quand on porte plusieurs casquettes ?',
                startLocal: '2025-09-12T10:00:00',
                endLocal: '2025-09-12T11:00:00',
                timezone: 'Europe/Paris',
                location: window.location.origin + '/newsletter/contenuWebinars.html',
                description: 'Merci pour votre inscription au webinar Social media manager : comment garder le contrôle quand on porte plusieurs casquettes ?. Malheureusement le webinar est terminé, mais vous pouvez accéder au replay en cliquant sur le lien ci-dessus.',
                reminderMinutes: 10
            };

            function toIcsDate(dtLocal, tz) {
                try {
                    const fmt = new Intl.DateTimeFormat('en-CA', {
                        timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                    const parts = Object.fromEntries(fmt.formatToParts(new Date(dtLocal)).map(p => [p.type, p.value]));
                    const y = parts.year, m = parts.month, d = parts.day;
                    const hh = parts.hour, mm = parts.minute, ss = parts.second;
                    const local = new Date(`${y}-${m}-${d}T${hh}:${mm}:${ss}`);
                    const utc = new Date(local.toLocaleString('en-US', { timeZone: 'UTC' }));
                    const pad = n => String(n).padStart(2, '0');
                    const y2 = utc.getUTCFullYear();
                    const m2 = pad(utc.getUTCMonth() + 1);
                    const d2 = pad(utc.getUTCDate());
                    const h2 = pad(utc.getUTCHours());
                    const mi2 = pad(utc.getUTCMinutes());
                    const s2 = pad(utc.getUTCSeconds());
                    return `${y2}${m2}${d2}T${h2}${mi2}${s2}Z`;
                } catch {
                    const dt = new Date(dtLocal);
                    return dt.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}Z$/, 'Z');
                }
            }

            function buildIcs(ev) {
                const dtStamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}Z$/, 'Z');
                const dtStart = toIcsDate(ev.startLocal, ev.timezone);
                const dtEnd = toIcsDate(ev.endLocal, ev.timezone);
                const uid = (Math.random().toString(36).slice(2)) + '@kyocera.local';
                const escape = s => String(s || '').replace(/[\\,;"]/g, m => ({'\\':'\\\\', ',':'\\,', ';':'\\;', '"':'\\"'}[m])).replace(/\r?\n/g, '\\n');
                let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Kyocera Newsletter//FR\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\n';
                ics += 'BEGIN:VEVENT\r\n';
                ics += `UID:${uid}\r\nDTSTAMP:${dtStamp}\r\nDTSTART:${dtStart}\r\nDTEND:${dtEnd}\r\n`;
                ics += `SUMMARY:${escape(ev.title)}\r\n`;
                ics += `DESCRIPTION:${escape(ev.description)}\r\n`;
                if (ev.location) ics += `LOCATION:${escape(ev.location)}\r\n`;
                if (ev.reminderMinutes && ev.reminderMinutes > 0) {
                    ics += 'BEGIN:VALARM\r\nACTION:DISPLAY\r\n';
                    ics += `TRIGGER:-PT${ev.reminderMinutes}M\r\nEND:VALARM\r\n`;
                }
                ics += 'END:VEVENT\r\nEND:VCALENDAR\r\n';
                return ics;
            }

            function downloadIcs(filename, content) {
                const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 500);
            }

            function googleCalendarUrl(ev) {
                const start = toIcsDate(ev.startLocal, ev.timezone);
                const end = toIcsDate(ev.endLocal, ev.timezone);
                const params = new URLSearchParams({
                    action: 'TEMPLATE',
                    text: ev.title,
                    details: ev.description,
                    location: ev.location || '',
                    dates: `${start}/${end}`
                });
                return `https://www.google.com/calendar/render?${params.toString()}`;
            }

            function outlookWebUrl(ev) {
                const start = new Date(ev.startLocal).toISOString();
                const end = new Date(ev.endLocal).toISOString();
                const params = new URLSearchParams({
                    path: '/calendar/action/compose',
                    rru: 'addevent',
                    startdt: start,
                    enddt: end,
                    subject: ev.title,
                    body: ev.description,
                    location: ev.location || ''
                });
                return `https://outlook.office.com/calendar/0/deeplink/compose?${params.toString()}`;
            }

            btnIcs.addEventListener('click', () => {
                const ics = buildIcs(event);
                downloadIcs('event.ics', ics);
                help.textContent = 'Fichier .ics téléchargé. Ouvrez-le avec Outlook, Apple Calendar ou autre.';
            });

            btnGoogle.addEventListener('click', () => {
                window.open(googleCalendarUrl(event), '_blank');
            });

            btnOutlook.addEventListener('click', () => {
                window.open(outlookWebUrl(event), '_blank');
            });
        })();

    </script>
</body>
</html>